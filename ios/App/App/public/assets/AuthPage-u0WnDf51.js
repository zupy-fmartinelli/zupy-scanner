import{u as I,a as Q,b as D,r as n,j as e,c as T,i as y,y as o}from"./main-CIC-T_B5.js";import{S as F,c as z,r as M,s as O}from"./ScannerComponent-Csi0myA0.js";const W="/assets/pwa-scanner-DroRE4gW.png";function B(){const{authenticateWithQR:w,loading:S,error:f}=I(),k=Q(),[l]=D(),[A,d]=n.useState(!1),[x,c]=n.useState(!1),[i,P]=n.useState(!1),[m,$]=n.useState(""),[g,j]=n.useState([]),[E,u]=n.useState(!1),[h,N]=n.useState(null),R=async s=>{s&&(i&&r(`Processing token from URL: ${s.substring(0,20)}...`),await p(s))};n.useEffect(()=>{const s=l.get("debug")==="true";P(s),s&&(r("Debug mode activated"),(async()=>{const t=await T();$(t),r(`API URL: ${t}`)})())},[l]),n.useEffect(()=>{const s=l.get("token");s&&setTimeout(()=>{R(s)},500)},[]),n.useEffect(()=>{const s=a=>{a.preventDefault(),N(a),!y()&&!window.matchMedia("(display-mode: standalone)").matches&&u(!0)};return window.addEventListener("beforeinstallprompt",s),()=>{window.removeEventListener("beforeinstallprompt",s)}},[]);const r=s=>{const a=new Date().toISOString().substr(11,8);j(t=>[...t,`[${a}] ${s}`])},C=async()=>{try{if(y()){if(!await z()&&!await M()){o.error("Camera permission is required for scanning");return}c(!0);const a=await O();a&&await p(a)}else d(!0)}catch(s){o.error(s.message||"Failed to start scanner"),console.error("Scanner error:",s)}finally{c(!1)}},L=async s=>{d(!1),await p(s)},p=async s=>{try{c(!0);let a=s;try{if(s.startsWith("http")&&s.includes("?token=")){const v=new URL(s).searchParams.get("token");v&&(a=v,i&&r("Detected URL with token parameter. Extracted token."))}}catch(t){console.error("Error parsing URL:",t)}i&&r(`QR data processed: ${a.substring(0,20)}...`),await w(a),i&&r("Authentication successful"),k("/scanner")}catch(a){o.error(a.message||"Authentication failed"),console.error("Auth error:",a),i&&(r(`Authentication failed: ${a.message}`),a.status&&r(`Status code: ${a.status}`))}finally{c(!1)}},b=async s=>{if(i)try{r(`Testing endpoint: ${m}${s}`);const t=(await fetch(`${m}${s}`,{method:"OPTIONS",headers:{Accept:"application/json"}})).status;r(`Response status: ${t}`),t>=200&&t<300?o.success(`Endpoint ${s} is accessible`):o.warning(`Endpoint ${s} returned status ${t}`)}catch(a){r(`Error: ${a.message}`),o.error(`Failed to access ${s}: ${a.message}`)}},U=async()=>{if(!h)return;h.prompt();const{outcome:s}=await h.userChoice;console.log(`User response to the install prompt: ${s}`),N(null),u(!1)};return e.jsx("div",{className:"d-flex flex-column min-vh-100 bg-dark text-white align-items-center",children:e.jsx("div",{className:"container py-5",children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-md-8 col-lg-6",children:[e.jsxs("div",{className:"text-center mb-5",children:[e.jsx("img",{src:W,alt:"Zupy Scanner",className:"img-fluid mb-4",style:{maxWidth:"200px"}}),e.jsx("h1",{className:"h2 mb-3",children:"Scanner Zupy"}),e.jsx("p",{className:"lead mb-4",children:"Escaneie o QR Code de Autorização para autenticar este dispositivo"})]}),E&&e.jsxs("div",{className:"alert alert-primary d-flex align-items-center mb-4",role:"alert",children:[e.jsx("i",{className:"bi bi-download me-2 fs-4"}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("strong",{children:"Instale este aplicativo"}),e.jsx("p",{className:"mb-2 small",children:"Instale o Scanner Zupy para um melhor desempenho e acesso offline."}),e.jsxs("button",{className:"btn btn-sm btn-primary",onClick:U,children:[e.jsx("i",{className:"bi bi-plus-circle me-1"}),"Instalar Aplicativo"]})]}),e.jsx("button",{type:"button",className:"btn-close",onClick:()=>u(!1),"aria-label":"Fechar"})]}),f&&e.jsx("div",{className:"alert alert-danger mb-4",role:"alert",children:f}),A?e.jsx("div",{className:"card bg-dark border-secondary mb-4",children:e.jsx("div",{className:"card-body p-0",children:e.jsx(F,{onQrScanned:L,onClose:()=>d(!1)})})}):e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"mb-3 alert alert-info",children:[e.jsx("i",{className:"bi bi-info-circle-fill me-2"}),"Para autorizar este dispositivo, escaneie o QR Code de Autorização fornecido pelo administrador"]}),e.jsx("button",{className:"btn btn-primary btn-lg px-5 py-3 mb-3",onClick:C,disabled:S||x,children:x?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Processando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-qr-code-scan me-2"}),"Escanear QR Code de Autorização"]})})]}),i&&e.jsxs("div",{className:"card bg-dark border-secondary mt-4",children:[e.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"m-0",children:"Modo de Depuração"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>j([]),children:"Limpar Log"})]}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"API URL"}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{type:"text",className:"form-control",value:m,readOnly:!0})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Testar Endpoints"}),e.jsxs("div",{className:"d-flex gap-2 mb-3",children:[e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>b("/scanner/api/v1/auth/"),children:"Auth"}),e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>b("/scanner/api/v1/auth-token/"),children:"Auth Token"}),e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>b("/scanner/api/v1/logout/"),children:"Logout"})]})]}),e.jsxs("div",{className:"mb-0",children:[e.jsx("label",{className:"form-label",children:"Log de Depuração"}),e.jsx("div",{className:"bg-dark border border-secondary p-3 small font-monospace",style:{height:"200px",overflowY:"auto",whiteSpace:"pre-wrap"},children:g.length===0?e.jsx("span",{className:"text-muted",children:"Nenhuma entrada de log"}):g.map((s,a)=>e.jsx("div",{children:s},a))})]})]})]}),e.jsx("div",{className:"text-center text-muted mt-4",children:e.jsx("small",{children:"Versão 1.0.0"})})]})})})})}export{B as default};
