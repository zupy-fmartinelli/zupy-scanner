import{u as C,a as I,b as D,r,j as e,c as Q,i as T,y as o}from"./main-N39Bu-dV.js";import{S as F}from"./ScannerComponent-DpX-vyBe.js";const Z="/assets/pwa-scanner-DroRE4gW.png";function W(){const{authenticateWithQR:v,loading:w,error:b}=C(),S=I(),[c]=D(),[k,i]=r.useState(!1),[x,d]=r.useState(!1),[l,A]=r.useState(!1),[m,$]=r.useState(""),[f,g]=r.useState([]),[E,u]=r.useState(!1),[h,j]=r.useState(null),L=async s=>{s&&(l&&n(`Processing token from URL: ${s.substring(0,20)}...`),await N(s))};r.useEffect(()=>{const s=c.get("debug")==="true";A(s),s&&(n("Debug mode activated"),(async()=>{const t=await Q();$(t),n(`API URL: ${t}`)})())},[c]),r.useEffect(()=>{const s=c.get("token");s&&setTimeout(()=>{L(s)},500)},[]),r.useEffect(()=>{const s=a=>{a.preventDefault(),j(a),!T()&&!window.matchMedia("(display-mode: standalone)").matches&&u(!0)};return window.addEventListener("beforeinstallprompt",s),()=>{window.removeEventListener("beforeinstallprompt",s)}},[]);const n=s=>{const a=new Date().toISOString().substr(11,8);g(t=>[...t,`[${a}] ${s}`])},P=async()=>{try{i(!0)}catch(s){o.error(s.message||"Failed to start scanner"),console.error("Scanner error:",s)}finally{d(!1)}},R=async s=>{i(!1),await N(s)},N=async s=>{try{d(!0);let a=s;try{if(s.startsWith("http")&&s.includes("?token=")){const y=new URL(s).searchParams.get("token");y&&(a=y,l&&n("Detected URL with token parameter. Extracted token."))}}catch(t){console.error("Error parsing URL:",t)}l&&n(`QR data processed: ${a.substring(0,20)}...`),await v(a),l&&n("Authentication successful"),S("/scanner")}catch(a){o.error(a.message||"Authentication failed"),console.error("Auth error:",a),l&&(n(`Authentication failed: ${a.message}`),a.status&&n(`Status code: ${a.status}`))}finally{d(!1)}},p=async s=>{if(l)try{n(`Testing endpoint: ${m}${s}`);const t=(await fetch(`${m}${s}`,{method:"OPTIONS",headers:{Accept:"application/json"}})).status;n(`Response status: ${t}`),t>=200&&t<300?o.success(`Endpoint ${s} is accessible`):o.warning(`Endpoint ${s} returned status ${t}`)}catch(a){n(`Error: ${a.message}`),o.error(`Failed to access ${s}: ${a.message}`)}},U=async()=>{if(!h)return;h.prompt();const{outcome:s}=await h.userChoice;console.log(`User response to the install prompt: ${s}`),j(null),u(!1)};return e.jsx("div",{className:"d-flex flex-column min-vh-100 bg-dark text-white align-items-center",children:e.jsx("div",{className:"container py-5",children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-md-8 col-lg-6",children:[e.jsxs("div",{className:"text-center mb-5",children:[e.jsx("img",{src:Z,alt:"Zupy Scanner",className:"img-fluid mb-4",style:{maxWidth:"200px"}}),e.jsx("h1",{className:"h2 mb-3",children:"Scanner Zupy"}),e.jsx("p",{className:"lead mb-4",children:"Para autenticar este dispositivo, escaneie o QR Code fornecido pelo administrador do programa Zupy."})]}),E&&e.jsxs("div",{className:"alert alert-primary d-flex align-items-center mb-4",role:"alert",children:[e.jsx("i",{className:"bi bi-download me-2 fs-4"}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("strong",{children:"Instale este aplicativo"}),e.jsx("p",{className:"mb-2 small",children:"Instale o Scanner Zupy para um melhor desempenho e acesso offline."}),e.jsxs("button",{className:"btn btn-sm btn-primary",onClick:U,children:[e.jsx("i",{className:"bi bi-plus-circle me-1"}),"Instalar Aplicativo"]})]}),e.jsx("button",{type:"button",className:"btn-close",onClick:()=>u(!1),"aria-label":"Fechar"})]}),b&&e.jsx("div",{className:"alert alert-danger mb-4",role:"alert",children:b}),k?e.jsx("div",{className:"scanner-fullscreen",children:e.jsx(F,{onQrScanned:R,onClose:()=>i(!1)})}):e.jsx("div",{className:"text-center",children:e.jsx("button",{className:"btn btn-primary btn-lg px-5 py-3 mb-3",onClick:P,disabled:w||x,children:x?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Processando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-qr-code-scan me-2"}),"Escanear QR Code de Autorização"]})})}),l&&e.jsxs("div",{className:"card bg-dark border-secondary mt-4",children:[e.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"m-0",children:"Modo de Depuração"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>g([]),children:"Limpar Log"})]}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"API URL"}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{type:"text",className:"form-control",value:m,readOnly:!0})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Testar Endpoints"}),e.jsxs("div",{className:"d-flex gap-2 mb-3",children:[e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>p("/scanner/api/v1/auth/"),children:"Auth"}),e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>p("/scanner/api/v1/auth-token/"),children:"Auth Token"}),e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>p("/scanner/api/v1/logout/"),children:"Logout"})]})]}),e.jsxs("div",{className:"mb-0",children:[e.jsx("label",{className:"form-label",children:"Log de Depuração"}),e.jsx("div",{className:"bg-dark border border-secondary p-3 small font-monospace",style:{height:"200px",overflowY:"auto",whiteSpace:"pre-wrap"},children:f.length===0?e.jsx("span",{className:"text-muted",children:"Nenhuma entrada de log"}):f.map((s,a)=>e.jsx("div",{children:s},a))})]})]})]}),e.jsxs("div",{className:"text-center text-muted mt-4",children:[e.jsx("small",{children:"Versão 1.0.0"}),e.jsx("br",{}),e.jsx("small",{children:e.jsx("a",{href:"https://zupy.com",target:"_blank",rel:"noopener noreferrer",className:"text-muted text-decoration-none",children:"zupy.com"})})]})]})})})})}export{W as default};
