import{u as D,a as Q,b as T,r,j as e,c as F,i as Z,y as l}from"./main-N4Ha74AW.js";import{S as M}from"./ScannerComponent-COi_j_9w.js";const O="/assets/pwa-scanner-DroRE4gW.png";function B(){const{authenticateWithQR:S,loading:w,error:b}=D(),k=Q(),[o]=T(),[A,i]=r.useState(!1),[x,d]=r.useState(!1),[$,f]=r.useState(!1),[c,E]=r.useState(!1),[m,L]=r.useState(""),[g,j]=r.useState([]),[P,u]=r.useState(!1),[h,N]=r.useState(null),R=async s=>{s&&(c&&n(`Processing token from URL: ${s.substring(0,20)}...`),await y(s))};r.useEffect(()=>{const s=o.get("debug")==="true";E(s),s&&(n("Debug mode activated"),(async()=>{const t=await F();L(t),n(`API URL: ${t}`)})())},[o]),r.useEffect(()=>{const s=o.get("token");s&&setTimeout(()=>{R(s)},500)},[]),r.useEffect(()=>{const s=a=>{a.preventDefault(),N(a),!Z()&&!window.matchMedia("(display-mode: standalone)").matches&&u(!0)};return window.addEventListener("beforeinstallprompt",s),()=>{window.removeEventListener("beforeinstallprompt",s)}},[]);const n=s=>{const a=new Date().toISOString().substr(11,8);j(t=>[...t,`[${a}] ${s}`])},U=async()=>{try{i(!0)}catch(s){l.error(s.message||"Failed to start scanner"),console.error("Scanner error:",s)}finally{d(!1)}},C=async s=>{i(!1),await y(s)},y=async s=>{try{d(!0);let a=s;try{if(s.startsWith("http")&&s.includes("?token=")){const v=new URL(s).searchParams.get("token");v&&(a=v,c&&n("Detected URL with token parameter. Extracted token."))}}catch(t){console.error("Error parsing URL:",t)}c&&n(`QR data processed: ${a.substring(0,20)}...`),await S(a),f(!0),c&&n("Authentication successful"),setTimeout(()=>{f(!1),k("/scanner")},1200)}catch(a){l.error(a.message||"Authentication failed"),console.error("Auth error:",a),c&&(n(`Authentication failed: ${a.message}`),a.status&&n(`Status code: ${a.status}`))}finally{d(!1)}},p=async s=>{if(c)try{n(`Testing endpoint: ${m}${s}`);const t=(await fetch(`${m}${s}`,{method:"OPTIONS",headers:{Accept:"application/json"}})).status;n(`Response status: ${t}`),t>=200&&t<300?l.success(`Endpoint ${s} is accessible`):l.warning(`Endpoint ${s} returned status ${t}`)}catch(a){n(`Error: ${a.message}`),l.error(`Failed to access ${s}: ${a.message}`)}},I=async()=>{if(!h)return;h.prompt();const{outcome:s}=await h.userChoice;console.log(`User response to the install prompt: ${s}`),N(null),u(!1)};return e.jsx("div",{className:"d-flex flex-column min-vh-100 bg-dark text-white align-items-center",children:e.jsx("div",{className:"container py-5",children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-md-8 col-lg-6",children:[e.jsxs("div",{className:"text-center mb-5",children:[e.jsx("img",{src:O,alt:"Zupy Scanner",className:"img-fluid mb-4",style:{maxWidth:"200px"}}),e.jsx("h1",{className:"h2 mb-3",children:"Scanner Zupy"}),e.jsx("p",{className:"lead mb-4",children:"Para autenticar este dispositivo, escaneie o QR Code fornecido pelo administrador do programa Zupy."})]}),P&&e.jsxs("div",{className:"alert alert-primary d-flex align-items-center mb-4",role:"alert",children:[e.jsx("i",{className:"bi bi-download me-2 fs-4"}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("strong",{children:"Instale este aplicativo"}),e.jsx("p",{className:"mb-2 small",children:"Instale o Scanner Zupy para um melhor desempenho e acesso offline."}),e.jsxs("button",{className:"btn btn-sm btn-primary",onClick:I,children:[e.jsx("i",{className:"bi bi-plus-circle me-1"}),"Instalar Aplicativo"]})]}),e.jsx("button",{type:"button",className:"btn-close",onClick:()=>u(!1),"aria-label":"Fechar"})]}),b&&e.jsx("div",{className:"alert alert-danger mb-4",role:"alert",children:b}),A?e.jsx("div",{className:"scanner-fullscreen",children:e.jsx(M,{onQrScanned:C,onClose:()=>i(!1)})}):e.jsxs("div",{className:"text-center",children:[$&&e.jsxs("div",{className:"alert alert-success mb-3",role:"alert",children:[e.jsx("i",{className:"bi bi-check-circle me-2"}),"Scanner autenticado com sucesso!"]}),e.jsx("button",{className:"btn btn-primary btn-lg px-5 py-3 mb-3",onClick:U,disabled:w||x,children:x?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Processando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-qr-code-scan me-2"}),"Escanear QR Code de Autorização"]})})]}),c&&e.jsxs("div",{className:"card bg-dark border-secondary mt-4",children:[e.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"m-0",children:"Modo de Depuração"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>j([]),children:"Limpar Log"})]}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"API URL"}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{type:"text",className:"form-control",value:m,readOnly:!0})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Testar Endpoints"}),e.jsxs("div",{className:"d-flex gap-2 mb-3",children:[e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>p("/scanner/api/v1/auth/"),children:"Auth"}),e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>p("/scanner/api/v1/auth-token/"),children:"Auth Token"}),e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>p("/scanner/api/v1/logout/"),children:"Logout"})]})]}),e.jsxs("div",{className:"mb-0",children:[e.jsx("label",{className:"form-label",children:"Log de Depuração"}),e.jsx("div",{className:"bg-dark border border-secondary p-3 small font-monospace",style:{height:"200px",overflowY:"auto",whiteSpace:"pre-wrap"},children:g.length===0?e.jsx("span",{className:"text-muted",children:"Nenhuma entrada de log"}):g.map((s,a)=>e.jsx("div",{children:s},a))})]})]})]}),e.jsxs("div",{className:"text-center text-muted mt-4",children:[e.jsx("small",{children:"Versão 1.0.0"}),e.jsx("br",{}),e.jsx("small",{children:e.jsx("a",{href:"https://zupy.com",target:"_blank",rel:"noopener noreferrer",className:"text-muted text-decoration-none",children:"zupy.com"})})]})]})})})})}export{B as default};
