import{u as I,a as D,b as Q,r as n,j as e,c as T,i as v,y as c}from"./main-8IGYUPaQ.js";import{S as F,c as Z,r as M,s as O}from"./ScannerComponent-0OvRdEkR.js";const W="/assets/pwa-scanner-DroRE4gW.png";function B(){const{authenticateWithQR:w,loading:S,error:f}=I(),k=D(),[i]=Q(),[P,d]=n.useState(!1),[x,l]=n.useState(!1),[o,A]=n.useState(!1),[m,$]=n.useState(""),[g,j]=n.useState([]),[E,u]=n.useState(!1),[h,N]=n.useState(null),R=async s=>{s&&(o&&r(`Processing token from URL: ${s.substring(0,20)}...`),await p(s))};n.useEffect(()=>{const s=i.get("debug")==="true";A(s),s&&(r("Debug mode activated"),(async()=>{const t=await T();$(t),r(`API URL: ${t}`)})())},[i]),n.useEffect(()=>{const s=i.get("token");s&&setTimeout(()=>{R(s)},500)},[]),n.useEffect(()=>{const s=a=>{a.preventDefault(),N(a),!v()&&!window.matchMedia("(display-mode: standalone)").matches&&u(!0)};return window.addEventListener("beforeinstallprompt",s),()=>{window.removeEventListener("beforeinstallprompt",s)}},[]);const r=s=>{const a=new Date().toISOString().substr(11,8);j(t=>[...t,`[${a}] ${s}`])},L=async()=>{try{if(v()){if(!await Z()&&!await M()){c.error("Camera permission is required for scanning");return}l(!0);const a=await O();a&&await p(a)}else d(!0)}catch(s){c.error(s.message||"Failed to start scanner"),console.error("Scanner error:",s)}finally{l(!1)}},C=async s=>{d(!1),await p(s)},p=async s=>{try{l(!0);let a=s;try{if(s.startsWith("http")&&s.includes("?token=")){const y=new URL(s).searchParams.get("token");y&&(a=y,o&&r("Detected URL with token parameter. Extracted token."))}}catch(t){console.error("Error parsing URL:",t)}o&&r(`QR data processed: ${a.substring(0,20)}...`),await w(a),o&&r("Authentication successful"),k("/scanner")}catch(a){c.error(a.message||"Authentication failed"),console.error("Auth error:",a),o&&(r(`Authentication failed: ${a.message}`),a.status&&r(`Status code: ${a.status}`))}finally{l(!1)}},b=async s=>{if(o)try{r(`Testing endpoint: ${m}${s}`);const t=(await fetch(`${m}${s}`,{method:"OPTIONS",headers:{Accept:"application/json"}})).status;r(`Response status: ${t}`),t>=200&&t<300?c.success(`Endpoint ${s} is accessible`):c.warning(`Endpoint ${s} returned status ${t}`)}catch(a){r(`Error: ${a.message}`),c.error(`Failed to access ${s}: ${a.message}`)}},U=async()=>{if(!h)return;h.prompt();const{outcome:s}=await h.userChoice;console.log(`User response to the install prompt: ${s}`),N(null),u(!1)};return e.jsx("div",{className:"d-flex flex-column min-vh-100 bg-dark text-white align-items-center",children:e.jsx("div",{className:"container py-5",children:e.jsx("div",{className:"row justify-content-center",children:e.jsxs("div",{className:"col-md-8 col-lg-6",children:[e.jsxs("div",{className:"text-center mb-5",children:[e.jsx("img",{src:W,alt:"Zupy Scanner",className:"img-fluid mb-4",style:{maxWidth:"200px"}}),e.jsx("h1",{className:"h2 mb-3",children:"Scanner Zupy"}),e.jsx("p",{className:"lead mb-4",children:"Para autenticar este dispositivo, escaneie o QR Code fornecido pelo administrador do programa Zupy."})]}),E&&e.jsxs("div",{className:"alert alert-primary d-flex align-items-center mb-4",role:"alert",children:[e.jsx("i",{className:"bi bi-download me-2 fs-4"}),e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("strong",{children:"Instale este aplicativo"}),e.jsx("p",{className:"mb-2 small",children:"Instale o Scanner Zupy para um melhor desempenho e acesso offline."}),e.jsxs("button",{className:"btn btn-sm btn-primary",onClick:U,children:[e.jsx("i",{className:"bi bi-plus-circle me-1"}),"Instalar Aplicativo"]})]}),e.jsx("button",{type:"button",className:"btn-close",onClick:()=>u(!1),"aria-label":"Fechar"})]}),f&&e.jsx("div",{className:"alert alert-danger mb-4",role:"alert",children:f}),P?e.jsx("div",{className:"scanner-fullscreen",children:e.jsx(F,{onQrScanned:C,onClose:()=>d(!1)})}):e.jsx("div",{className:"text-center",children:e.jsx("button",{className:"btn btn-primary btn-lg px-5 py-3 mb-3",onClick:L,disabled:S||x,children:x?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Processando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"bi bi-qr-code-scan me-2"}),"Escanear QR Code de Autorização"]})})}),o&&e.jsxs("div",{className:"card bg-dark border-secondary mt-4",children:[e.jsxs("div",{className:"card-header d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"m-0",children:"Modo de Depuração"}),e.jsx("button",{className:"btn btn-sm btn-outline-secondary",onClick:()=>j([]),children:"Limpar Log"})]}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"API URL"}),e.jsx("div",{className:"input-group mb-3",children:e.jsx("input",{type:"text",className:"form-control",value:m,readOnly:!0})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{className:"form-label",children:"Testar Endpoints"}),e.jsxs("div",{className:"d-flex gap-2 mb-3",children:[e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>b("/scanner/api/v1/auth/"),children:"Auth"}),e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>b("/scanner/api/v1/auth-token/"),children:"Auth Token"}),e.jsx("button",{className:"btn btn-sm btn-outline-primary",onClick:()=>b("/scanner/api/v1/logout/"),children:"Logout"})]})]}),e.jsxs("div",{className:"mb-0",children:[e.jsx("label",{className:"form-label",children:"Log de Depuração"}),e.jsx("div",{className:"bg-dark border border-secondary p-3 small font-monospace",style:{height:"200px",overflowY:"auto",whiteSpace:"pre-wrap"},children:g.length===0?e.jsx("span",{className:"text-muted",children:"Nenhuma entrada de log"}):g.map((s,a)=>e.jsx("div",{children:s},a))})]})]})]}),e.jsxs("div",{className:"text-center text-muted mt-4",children:[e.jsx("small",{children:"Versão 1.0.0"}),e.jsx("br",{}),e.jsx("small",{children:e.jsx("a",{href:"https://zupy.com",target:"_blank",rel:"noopener noreferrer",className:"text-muted text-decoration-none",children:"zupy.com"})})]})]})})})})}export{B as default};
